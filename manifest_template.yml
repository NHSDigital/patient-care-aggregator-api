SERVICE_NAME: patient-care-aggregator-api
PRODUCT_DISPLAY_NAME: Patient Care Aggregator
DESCRIPTION: example description
APIGEE_ENVIRONMENTS:
  - name: internal-dev
    display_name: Internal Development
  - name: internal-dev-sandbox
    display_name: Internal Development Sandbox
  - name: internal-qa
    display_name: Internal QA
  # - name: internal-qa-sandbox
  #   display_name: Internal QA Sandbox
  # - name: ref
  #   display_name: Reference
  - name: sandbox
    display_name: Sandbox
    portal_visibility: false
  - name: int
    display_name: Integration Testing

INTERNAL_DEV_VARIANTS:
    - name: internal-dev
    - name: alpha-internal-dev
    - name: nft-internal-dev
---
meta:
  api:
    name: patient-care-aggregator-api
    guid: 92103283-2be2-42b3-b008-80d246d90f85
    spec_guids:
      - 2d4c93af-0022-47d8-b952-2bbcadbaa36a
  schema_version: 1.3
apigee:
  environments:
{% for ENV in APIGEE_ENVIRONMENTS %}
{% set TITLE = PRODUCT_DISPLAY_NAME + ' (' + ENV.display_name + ' Environment)' %}
{% set NAME = SERVICE_NAME + '-' + ENV.name %}
{% if ENV.name == 'internal-dev' %}
    - name: internal-dev
      products:
{% for VARIANT in INTERNAL_DEV_VARIANTS %}
{% set PRODUCT_NAME = SERVICE_NAME + '-' + VARIANT.name %}
        - name: {{ PRODUCT_NAME }}
          approvalType: auto
          attributes:
            - name: access
              value: public
            - name: ratelimiting
              value:
                 {{ PRODUCT_NAME }}:
                  quota:
                    enabled: true
                    limit: 6000
                    interval: 1
                    timeunit: minute
                  spikeArrest:
                    enabled: true
                    ratelimit: 6000pm # 100 requests per second
                app:
                  quota:
                    enabled: false
                  spikeArrest:
                    enabled: false
          description: {{ DESCRIPTION }}
          displayName: {{ TITLE }} ({{ ENV.display_name}} - {{ VARIANT.name }})
          environments: [ internal-dev ]
          proxies:
            - {{ VARIANT.name }}
            - identity-service-internal-dev
          scopes:
            - 'urn:nhsd:apim:user-nhs-login:P9:{{ SERVICE_NAME }}'
{% endfor %}
      specs:
        - name: {{ NAME }}
          path: {{ SERVICE_NAME }}.json
      api_catalog:
        - edgeAPIProductName: {{ NAME }}
          anonAllowed: true
          description: {{ DESCRIPTION }}
          requireCallbackUrl: false
          title: {{ TITLE }}
          visibility: {{ ENV.portal_visibility | default(true) }}
          specId: {{ NAME }}
{% else %}
    - name: {{ ENV.name }}
      products:
        - name: {{ NAME }}
          approvalType: auto
          attributes:
            - name: access
              value: public
              # For a parameterised example of rate limiting per environment,
              # see https://github.com/NHSDigital/personal-demographics-service-api/blob/master/manifest_template.yml
            - name: ratelimiting
              value:
                {{ NAME }}:
                  quota:
                    enabled: true
                    limit: 6000
                    interval: 1
                    timeunit: minute
                  spikeArrest:
                    enabled: true
                    ratelimit: 6000pm # 10 requests per second
                app:
                  quota:
                    enabled: false
                  spikeArrest:
                    enabled: false
          description: {{ DESCRIPTION }}
          displayName: {{ TITLE }}
          environments: [ {{ ENV.name }} ]
          proxies:
            - {{ NAME }}
            - identity-service-{{ ENV.name }}
{% if ENV.name == 'int' %}
            - identity-service-{{ ENV.name }}-no-smartcard
{% endif %}
{% if ENV.name == 'internal-qa' %}
            - identity-service-internal-qa-int
{% endif %}
          scopes:
            - 'urn:nhsd:apim:user-nhs-login:P9:{{ SERVICE_NAME }}'
      specs:
        - name: {{ NAME }}
          path: {{ SERVICE_NAME }}.json
      api_catalog:
        - edgeAPIProductName: {{ NAME }}
          anonAllowed: true
          description: {{ DESCRIPTION }}
          requireCallbackUrl: false
          title: {{ TITLE }}
          visibility: {{ ENV.portal_visibility | default(true) }}
          specId: {{ NAME }}
{% endif %}
{% endfor %}

