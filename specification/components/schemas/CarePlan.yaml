description: "Details of the referrals and bookings found for the patient, expressed as a FHIR `CarePlan` resource."
type: object
required:
  - fullUrl
  - resource
  - search
properties:
  fullUrl:
    description: "URI for the `CarePlan` resource."
    type: string
    example: "https://servita-sandbox.co.uk/CarePlan/1"
  search:
    description: "Search-related information for the `CarePlan` resource."
    type: object
    required:
      - mode
    properties:
      mode:
        description: "Indicates why this resource is in the result set - in this case because it includes infomation that matched the requested patient."
        enum:
          - match
  resource:
    description: "The `CarePlan` resource itself."
    type: object
    required:
      - resourceType
      - status
      - intent
      - subject
      - activity
    properties:
      resourceType:
        description: "FHIR resource type."
        type: string
        enum:
          - "CarePlan"
      status:
        description: "Status of the care plan."
        type: string
        enum:
          - "active"
      intent:
        description: "Level of authority / intentionality associated with the care plan and where the care plan fits into the workflow chain."
        type: string
        enum:
          - "order"
      subject:
        description: "Patient or group whose intended care is described by the plan."
        type: object
        required:
          - identifier
# TBC Confluence spec doesn't mention identifier but it's in the JSON example - I assume it is a thing, and I assume it's required          
        properties:
          identifier:
            description: "Unique identifier for the patient - specifically, their NHS number."
            type: object
            required:
              - system
              - value
# TBC Confluence spec say system and value are optional, but I suspect they are required              
            properties:
              system:
                description: "Type of identifier."
                type: string
                enum:
                  - "https://fhir.nhs.uk/Id/nhs-number"
              value:
                description: "The NHS number itself."
                type: string
                example: "8462486238"
# TBC should this be our standard example NHS number 9000000009? All "fake" NHS numbers should at least begin with a "9"
      activity:
        description: "List of referrals and bookings found for the patient."
        type: array
        items:
          description: "A single referral or booking for the patient."
          type: object
          required:
            - detail
          properties:
            reference:
              description: "e-RS Unique Booking Reference Number (UBRN) for the referral, if this activity is an e-RS referral, expressed as a referencve to a FHIR `ServiceRequest` resource."
              type: object
              required:
                - type
                - identifier
# Confluence says the properties are all optional but I suspect they are required *if* the "reference" object is present
              properties:
                type:
                  description: "FHIR resource type for the reference."
                  type: string
                  enum:
                    - "ServiceRequest"
# TBC Confluence spec says this could be "ServiceRequest" or null, but under what conditions would the reference object be present and the type be null? I suspect that doesn't happen.
                identifier:
                  description: "Unique identifier for the e-RS referral - specifically an e-RS Unique Booking Reference Number (UBRN)."
                  type: object
                  required:
                    - system
                    - value
                  properties:
                    system:
                      description: "Code system used for the identifier."
                      type: string
                      example: "https://fhir.nhs.uk/Id/UBRN"
                    value:
                      description: "The e-RS Unique Booking Reference Number (UBRN) itself."
                      type: string
                      example: "808993698030"
            detail:
              description: "Details of the referral or booking."
              type: object
              required:
                - kind
                - description
                - performer
# Confluence says performer is required but the example has no performer for the "Appointment" activity
              properties:
                kind:
                  description: "Type of activity - referral (`ServiceRequest`) or booking (`Appointment`)."
                  type: string
                  enum:
                    - "ServiceRequest"
                    - "Appointment"
                extension:
                  description: "FHIR extension wrapper for various country-specific data items."                  
                  type: array
                  items:
                    oneOf:
                      - description: "URL for a patient-facing web application for the referral or booking."
# Is this extension always present?                      
                        type: object
                        required:
                          - url
                          - valueUrl
# Confluence spec says the extension for the back-end application details is optional - is this correct or is it always present?                          
                        properties:
                          url:
                            description: "FHIR extension type."
                            type: string
                            enum:
                              - "https://fhir.nhs.uk/StructureDefinition/Extension-Portal-Link"
                          valueUrl:
                            description: "The URL itself."
                            type: string
                            example: "https://refer.nhs.uk/nhslogin?ubrn=808993698030"
                          extension:
                            description: "FHIR extension wrapper for the details of which back-end application the referral or booking came from."
                            type: array
                            items:
                              description: "Unique identifier for the back-end application the referral or booking came from."
                              type: object
                              required:
                                - url
                                - valueCode
                              properties:
                                url:
                                  description: "FHIR extension type for the identifier."
                                  type: string
                                  enum:
                                    - "client-id"
# TBC this is not a valid URL - would expect it to be a FHIR UK Core extension
                                valueCode:
                                  description: "The identifier itself. Note that identifiers ending in `static-mock` only occur in test environments."
                                  type: string
                                  enum:
                                    - ers-static-mock
                                    - pkb-static-mock
                                    - drdoctor-static-mock
                                    - netcall-static-mock
                                    - zesty-static-mock
                                    - netcall-01
                                    - dr-doctor-01
                                    - zesty-01
                      - description: "Status of the activity, if it is an e-RS referral."
# Is this extension always present for an e-RS referral?
                        type: object
                        required:
                          - url
                          - valueCoding
                        properties:
                          url:
                            description: "FHIR extension type for the e-RS referral status."
                            type: string
                            enum:
                              - "https://fhir.nhs.uk/StructureDefinition/Extension-eRS-ServiceRequest-State"
                          valueCoding:
                            description: "Wrapper for the e-RS referral status."
                            type: object
                            required:
                              - system
                              - code
# TBC Confluence spec says system and code are optional but I'd be surprised if they are!                              
                            properties:
                              system:
                                description: "Code system used for the e-RS referral status."
                                type: string
                                enum:
                                  - "https://fhir.nhs.uk/CodeSystem/eRS-ReferralState"
                              code:
                                description: "The e-RS request status itself."
                                type: string
                                enum:
                                  - bookable
                                  - bookableWasCancelled
                                  - inReview
# TBC JSON example is "Bookable" (capital B) whereas the Confluence spec says "bookable" - which is correct?                                
                      - description: "Status of the activity, if it is a booking."
# Is this extension always present for a booking?
# TBC all through the spec I say "booking" because that's the language BaRS uses. But the Confluence spec uses "appointment" and FHIR says "appointment". Which should I use? Need to discuss with BaRS team.
                        type: object
                        required:
                          - url
                          - valueCoding
                        properties:
                          url:
                            description: "FHIR extension type for the booking status."
                            type: string
                            enum:
                              - "https://fhir.nhs.uk/StructureDefinition/Extension-Appointment-Status"
                          valueCoding:
                            description: "Wrapper for the booking status."
                            type: object
                            required:
                              - system
                              - code
# TBC Confluence spec says system and code are optional but I'd be surprised if they are!                              
                            properties:
                              system:
                                description: "Code system used for the booking status."
                                type: string
                                enum:
                                  - "http://hl7.org/fhir/appointmentstatus"
                              code:
                                description: "The e-RS request status itself."
                                type: string
                                enum:
                                  - booked
                                  - cancelled
                                  - bookedPendingCancellation
                                  - bookedPendingReschedule
                                  - bookedPendingChange
                                  - cancelledPendingReschedule
                      - description: "The specialty of the service to which the referral or booking applies."
# Is this extension always present? Or is it only for a booking? Or only for a referral?
                        type: object
                        required:
                          - url
                          - valueCoding
                        properties:
                          url:
                            description: "FHIR extension type for the specialty."
                            type: string
                            enum:
                              - "https://fhir.nhs.uk/StructureDefinition/Extension-Specialty"
                          valueCoding:
                            description: "Wrapper for the specialty."
                            type: object
                            required:
                              - system
                              - display
# TBC Confluence spec says system and code are optional but I'd be surprised if they are!
                            properties:
                              system:
                                description: "Code system used for the specialty."
                                type: string
                                enum:
                                  - "https://fhir.nhs.uk/STU3/CodeSystem/Specialty-1"
# TBC why is this a STU3 coding? Ah, probably because e-RS is a STU3 API? Shouldn't we be converting it?                                
                              display:
                                description: "The specialty itself, in plain text."
                                type: string
                                example: "TRAUMA & ORTHOPAEDICS"
                      - description: "The consultation medium for the booking (face-to-face or virtual), if the activity is a booking."
# Is this extension always present for a booking?
                        type: object
                        required:
                          - url
                          - valueCode
                        properties:
                          url:
                            description: "FHIR extension type for the consultation medium code."
                            type: string
                            enum:
                              - "https://fhir.nhs.uk/StructureDefinition/Extension-Consultation-Medium"
                          valueCode:
                            description: "The consultation code medium itself."
                            type: string
                            enum:
                              - "FACE_TO_FACE"
                              - "VIRTUAL"
                description:
                  description: "TBC description."
                  type: string
                  example: "Rheumatology - Metabolic Bone (inc Complex and Non-Complex cases) - Freeman - Newcastle FT - RTD"
                scheduledPeriod:
                  description: "TBC scheduledPeriod."
                  type: object
#                  required:
#                    - TBC
                  properties:
                    start:
                      description: "TBC start."
                      type: string                      
                      example: "2021-05-23T10:02:15.960"
                    extension:
                      description: "TBC scheduled period extension."
                      type: array
                      items:
                        oneOf:
                          - description: "TBC planned wait time."
                            type: object
#                            required:
#                              TBC
                            properties:
                              url:
                                description: "TBC."
                                type: string
                                enum:
                                  - "https://fhir.nhs.uk/StructureDefinition/Extension-PlannedWaitTime"
                              valueDuration:
                                description: "TBC."
                                type: object
#                                required:
#                                  TBC
                                properties:
                                  unit:
                                    description: "TBC."
                                    type: string
                                    enum:
                                      - "TBC"
                                  value:
                                    description: "TBC."
                                    type: string
                                    example: "45"
                          - description: "TBC review due date."
                            type: object
#                            required:
#                              TBC
                            properties:
                              url:
                                description: "TBC."
                                type: string
                                enum:
                                  - "https://fhir.nhs.uk/StructureDefinition/Extension-PlannedWaitTime"
                              valueDate:
                                description: "TBC."
                                type: string
                                example: "2020-11-19"
                performer:
                  description: "TBC."
                  type: array
                  items:
                    description: "TBC."
                    type: object
#                    required:
#                      - TBC
                    properties:
                      type:
                        description: "TBC."
                        type: string
                        enum:
                          - "TBC"
                      display:
                        description: "TBC."
                        type: string
                        example: "THE NEWCASTLE UPON TYNE HOSPITALS NHS FOUNDATION TRUST"
# looks like performer could be a HealthcareService or an Organization
